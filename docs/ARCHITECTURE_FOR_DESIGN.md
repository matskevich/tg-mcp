# 🎨 Описание архитектуры для визуализации: Session + Anti-Spam система

## 📐 Общая архитектура системы

### Компоненты системы (5 основных блоков)

```
┌─────────────────────────────────────────────────────────────────┐
│                    S16-LEADS TELEGRAM SYSTEM                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐      ┌──────────────┐      ┌─────────────┐ │
│  │   Session    │      │   Rate       │      │   Metrics    │ │
│  │  Management  │      │   Limiter    │      │   Collector  │ │
│  │              │      │              │      │              │ │
│  │ tele_client  │      │   limiter.py  │      │  metrics.py  │ │
│  └──────┬───────┘      └──────┬───────┘      └──────┬───────┘ │
│         │                      │                      │         │
│         │                      │                      │         │
│  ┌──────▼──────────────────────▼──────────────────────▼───────┐ │
│  │                                                               │ │
│  │              Safe Call Wrapper (limiter.py)                   │ │
│  │                                                               │ │
│  └───────────────────────────┬───────────────────────────────────┘ │
│                              │                                     │
│  ┌───────────────────────────▼───────────────────────────────────┐ │
│  │                                                               │ │
│  │              High-Level API (groups.py)                       │ │
│  │              GroupManager                                     │ │
│  │                                                               │ │
│  └───────────────────────────┬───────────────────────────────────┘ │
│                              │                                     │
│                              ▼                                     │
│                    ┌─────────────────┐                             │
│                    │  Telegram API   │                             │
│                    │   (Telethon)    │                             │
│                    └─────────────────┘                             │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Поток данных: Как работает запрос

### Сценарий: Получение информации о группе

```
┌─────────────┐
│  Developer  │
│   Code      │
└──────┬──────┘
       │
       │ manager.get_group_info("s16_space")
       ▼
┌─────────────────────────────────────┐
│   GroupManager (groups.py)         │
│   - Высокоуровневый API            │
│   - Скрывает детали антиспама     │
└──────┬──────────────────────────────┘
       │
       │ _safe_api_call(client.get_entity, ...)
       ▼
┌─────────────────────────────────────┐
│   Safe Call Wrapper (limiter.py)   │
│                                     │
│   1. Проверка квот                 │
│   2. Получение токена из bucket    │
│   3. Выполнение функции            │
│   4. Retry при FLOOD_WAIT          │
└──────┬──────────────────────────────┘
       │
       │ await bucket.acquire(1)
       ▼
┌─────────────────────────────────────┐
│   Token Bucket (limiter.py)        │
│                                     │
│   ┌─────────┐                      │
│   │ Tokens: │  [████████░░] 8/10   │
│   └─────────┘                      │
│   Refill: 4 tokens/sec              │
│                                     │
│   Если токенов нет → ждем          │
└──────┬──────────────────────────────┘
       │
       │ Токен получен ✅
       ▼
┌─────────────────────────────────────┐
│   Telegram Client (tele_client.py) │
│                                     │
│   1. Читает session файл           │
│   2. Авторизуется автоматически    │
│   3. Выполняет API запрос          │
└──────┬──────────────────────────────┘
       │
       │ HTTP Request (MTProto)
       ▼
┌─────────────────────────────────────┐
│      Telegram Servers               │
│                                     │
│  - Проверяет авторизацию           │
│  - Выполняет запрос                │
│  - Возвращает данные или FLOOD_WAIT│
└─────────────────────────────────────┘
```

---

## 🗂️ Детальное описание компонентов

### 1. Session Management (`tele_client.py`)

**Визуализация:**
```
┌─────────────────────────────────────────────┐
│         Session Management                  │
├─────────────────────────────────────────────┤
│                                             │
│  ┌──────────────┐      ┌──────────────┐  │
│  │   .session   │      │  Telegram     │  │
│  │    файл      │◄─────┤  Client       │  │
│  │              │      │               │  │
│  │ data/sessions│      │ TelegramClient│  │
│  │ /s16_session │      │  (Telethon)   │  │
│  │    .session  │      │               │  │
│  └──────┬───────┘      └───────┬───────┘  │
│         │                      │          │
│         │ Права: 600           │          │
│         │ (rw-------)         │          │
│         │                      │          │
│         └──────────┬───────────┘          │
│                    │                      │
│                    ▼                      │
│         ┌──────────────────┐             │
│         │  Авторизация      │             │
│         │  (автоматическая) │             │
│         └──────────────────┘             │
│                                             │
└─────────────────────────────────────────────┘
```

**Что делает:**
- Хранит токены авторизации в `.session` файле
- При первом запуске: запрашивает телефон + код → сохраняет в `.session`
- При последующих запусках: читает `.session` → авторизуется автоматически
- Устанавливает права 600 (только владелец может читать/писать)

**Ключевые функции:**
- `get_client()` - создает клиент с дефолтным session
- `get_client_for_session(path)` - создает клиент с указанным session
- `_harden_session_storage()` - устанавливает права 600

---

### 2. Rate Limiter (`limiter.py` - Token Bucket)

**Визуализация:**
```
┌─────────────────────────────────────────────┐
│         Token Bucket Algorithm              │
├─────────────────────────────────────────────┤
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │         Token Bucket               │   │
│  │                                     │   │
│  │  Capacity: 10 tokens               │   │
│  │  ┌─────────────────────────────┐   │   │
│  │  │ ████████░░ 8/10 tokens      │   │   │
│  │  └─────────────────────────────┘   │   │
│  │                                     │   │
│  │  Refill Rate: 4 tokens/sec        │   │
│  │  ──────────────────────────────── │   │
│  │  ⏱️  Пополнение каждую секунду     │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │      Запрос токена                 │   │
│  │                                     │   │
│  │  acquire(1) →                      │   │
│  │    • Есть токен? → ✅ Выдать       │   │
│  │    • Нет токена? → ⏳ Ждать        │   │
│  └─────────────────────────────────────┘   │
│                                             │
└─────────────────────────────────────────────┘
```

**Что делает:**
- Хранит "токены" в "ведре" (capacity = 10)
- Пополняет токены со скоростью 4 токена/сек (refill_rate)
- При запросе: тратит 1 токен, если токенов нет - ждет пополнения
- Обеспечивает плавное ограничение скорости (не резкие блокировки)

**Аналогия:**
Представь ведро с водой:
- Ведро вмещает 10 литров (capacity)
- Вода течет со скоростью 4 л/сек (refill_rate)
- Каждый запрос забирает 1 литр
- Если воды нет - ждем пока натечет

---

### 3. Safe Call Wrapper (`limiter.py` - safe_call)

**Визуализация:**
```
┌─────────────────────────────────────────────┐
│         Safe Call Wrapper                   │
├─────────────────────────────────────────────┤
│                                             │
│  Запрос: client.get_entity(group_id)      │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │  1. Проверка квот                  │   │
│  │     • DM операция? → check_dm()   │   │
│  │     • Join операция? → check_join()│   │
│  └──────────────┬──────────────────────┘   │
│                 │ ✅ Квота OK              │
│                 ▼                           │
│  ┌─────────────────────────────────────┐   │
│  │  2. Получение токена              │   │
│  │     await bucket.acquire(1)       │   │
│  │     • Ждем если токенов нет      │   │
│  └──────────────┬──────────────────────┘   │
│                 │ ✅ Токен получен         │
│                 ▼                           │
│  ┌─────────────────────────────────────┐   │
│  │  3. Выполнение функции            │   │
│  │     result = await func(...)       │   │
│  └──────────────┬──────────────────────┘   │
│                 │                           │
│        ┌────────┴────────┐                 │
│        │                 │                  │
│     ✅ Успех        ❌ FLOOD_WAIT          │
│        │                 │                  │
│        │                 ▼                  │
│        │     ┌───────────────────────┐     │
│        │     │ 4. Retry Logic       │     │
│        │     │   • Exponential      │     │
│        │     │     backoff           │     │
│        │     │   • Max 3 retries    │     │
│        │     └───────────────────────┘     │
│        │                 │                  │
│        └────────┬────────┘                 │
│                 │                           │
│                 ▼                           │
│         ┌───────────────┐                  │
│         │   Результат   │                  │
│         └───────────────┘                  │
│                                             │
└─────────────────────────────────────────────┘
```

**Что делает:**
- Обертка для всех Telegram API вызовов
- Проверяет квоты перед выполнением (для DM/join)
- Получает токен из bucket (rate limiting)
- Выполняет функцию
- При FLOOD_WAIT: автоматический retry с exponential backoff
- Логирует все события с тегом `[SAFE]`

**Почему важно:**
- Единая точка контроля всех API вызовов
- Автоматическая защита от блокировок
- Разработчик не думает о защите - она работает автоматически

---

### 4. Квоты (Daily Limits) (`limiter.py` - RateLimiter)

**Визуализация:**
```
┌─────────────────────────────────────────────┐
│         Daily Quotas System                 │
├─────────────────────────────────────────────┤
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │   DM Quota                         │   │
│  │   ┌─────────────────────────────┐ │   │
│  │   │ ████████░░░░░░░░░░ 8/20     │ │   │
│  │   └─────────────────────────────┘ │   │
│  │   Лимит: 20 DM/день               │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │   Join Quota                        │   │
│  │   ┌─────────────────────────────┐ │   │
│  │   │ ████░░░░░░░░░░░░░░░░ 4/20   │ │   │
│  │   └─────────────────────────────┘ │   │
│  │   Лимит: 20 Join/день              │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │   Storage                           │   │
│  │   data/anti_spam/                   │   │
│  │   daily_counters.txt                │   │
│  │                                     │   │
│  │   date=2025-01-15                  │   │
│  │   dm_count=8                       │   │
│  │   join_count=4                     │   │
│  │   api_calls=156                    │   │
│  │   flood_waits=2                    │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ⏰ Автоматический сброс в 00:00 UTC       │
│                                             │
└─────────────────────────────────────────────┘
```

**Что делает:**
- Хранит счетчики операций в файле `daily_counters.txt`
- Проверяет квоты перед выполнением операций
- Блокирует операции при превышении лимита
- Автоматически сбрасывает счетчики при смене дня (00:00 UTC)

**Лимиты:**
- DM: 20 сообщений/день
- Join/Leave: 20 операций/день
- API calls: без лимита (но через rate limiter)

---

### 5. High-Level API (`groups.py` - GroupManager)

**Визуализация:**
```
┌─────────────────────────────────────────────┐
│         GroupManager                         │
│         (High-Level API)                     │
├─────────────────────────────────────────────┤
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │  Удобные методы для разработчика    │   │
│  │                                     │   │
│  │  • get_group_info(group_id)        │   │
│  │  • get_participants(group_id)      │   │
│  │  • search_participants(group_id)   │   │
│  │  • get_group_creation_date()      │   │
│  └──────────────┬──────────────────────┘   │
│                 │                           │
│                 │ Автоматически использует  │
│                 │ _safe_api_call()          │
│                 ▼                           │
│  ┌─────────────────────────────────────┐   │
│  │  Внутри:                            │   │
│  │  • Все вызовы через safe_call       │   │
│  │  • Smart pause для больших операций │   │
│  │  • Автоматическая обработка ошибок  │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  Разработчик НЕ думает о:                  │
│  • Rate limiting                            │
│  • Квотах                                   │
│  • FLOOD_WAIT                               │
│  • Retry логике                             │
│                                             │
└─────────────────────────────────────────────┘
```

**Что делает:**
- Предоставляет удобный API для работы с группами
- Скрывает детали антиспам системы
- Автоматически применяет защиту через `_safe_api_call()`
- Использует `smart_pause()` для больших операций

**Почему важно:**
- Разделение ответственности
- Удобство для разработчика
- Автоматическая защита без дополнительного кода

---

### 6. Metrics Collector (`metrics.py`)

**Визуализация:**
```
┌─────────────────────────────────────────────┐
│         Metrics Collector                   │
├─────────────────────────────────────────────┤
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │  Counters                           │   │
│  │  • rate_limit_requests_total: 156   │   │
│  │  • rate_limit_throttled_total: 12   │   │
│  │  • flood_wait_events_total: 2       │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │  Latency Histogram                  │   │
│  │  ≤0.05s: ████████ 45                │   │
│  │  ≤0.1s:  ██████ 32                  │   │
│  │  ≤0.25s: ████ 18                   │   │
│  │  ≤0.5s:  ██ 8                      │   │
│  │  ≤1s:    █ 3                       │   │
│  │  ≤2s:    ░ 0                       │   │
│  │  ≤5s:    ░ 0                       │   │
│  │  >5s:    ░ 0                       │   │
│  └─────────────────────────────────────┘   │
│                                             │
└─────────────────────────────────────────────┘
```

**Что делает:**
- Собирает метрики работы системы
- Счетчики: запросы, throttles, flood_waits
- Гистограмма задержек API вызовов
- Thread-safe операции

---

## 🔄 Полный цикл: От запроса до ответа

### Пример: Получение участников группы

```
1. Developer Code
   └─> manager.get_participants("s16_space", limit=100)
       │
       ▼
2. GroupManager
   └─> _safe_api_call(get_participants_safe)
       │
       ▼
3. Safe Call Wrapper
   ├─> Проверка квот ✅
   ├─> await bucket.acquire(1) ⏳ (если нужно)
   ├─> Выполнение функции
   │   └─> client.iter_participants(...)
   │       │
   │       ├─> ✅ Успех → возврат результата
   │       │
   │       └─> ❌ FLOOD_WAIT(5s)
   │           └─> Retry через 5s + backoff
   │               └─> ✅ Успех
   │
   └─> Увеличение счетчиков
       │
       ▼
4. Smart Pause (каждые 1000 участников)
   └─> await asyncio.sleep(1.0)
       │
       ▼
5. Результат возвращается разработчику
```

---

## 📊 Визуальные элементы для схемы

### Цветовая схема (рекомендация):

- **Session Management**: 🔵 Синий (безопасность, хранение)
- **Rate Limiter**: 🟢 Зеленый (контроль, ограничение)
- **Safe Call**: 🟡 Желтый (защита, обертка)
- **High-Level API**: 🟣 Фиолетовый (удобство, абстракция)
- **Telegram API**: 🔴 Красный (внешний сервис)
- **Metrics**: ⚪ Серый (мониторинг)

### Иконки для компонентов:

- **Session**: 📁 файл / 🔐 замок
- **Token Bucket**: 🪣 ведро / ⏱️ таймер
- **Safe Call**: 🛡️ щит / 🔄 цикл
- **Quotas**: 📊 график / ⏰ часы
- **GroupManager**: 👥 группа / 🏢 здание
- **Metrics**: 📈 график / 📉 статистика

### Стрелки и потоки:

- **Толстая стрелка** → основной поток данных
- **Тонкая стрелка** → вторичный поток / проверка
- **Пунктирная стрелка** → опциональный поток
- **Красная стрелка** → ошибка / retry
- **Зеленая стрелка** → успех

---

## 🎯 Ключевые моменты для схемы

1. **Session = авторизация без кода**
   - Покажи файл `.session` как хранилище токенов
   - Стрелка от файла к клиенту (чтение)
   - Стрелка от клиента к файлу (запись при первом входе)

2. **Token Bucket = плавное ограничение**
   - Визуализируй ведро с токенами
   - Покажи пополнение (стрелка сверху)
   - Покажи расход (стрелка снизу)

3. **Safe Call = автоматическая защита**
   - Покажи как обертка окружает все API вызовы
   - Стрелки: проверка квот → получение токена → выполнение → retry

4. **Квоты = защита от блокировок**
   - Покажи счетчики как прогресс-бары
   - Файл счетчиков с данными
   - Стрелка сброса в 00:00 UTC

5. **Интеграция = прозрачность**
   - Покажи как GroupManager скрывает детали
   - Стрелки показывают что все автоматически

---

## 📐 Рекомендуемая структура схемы

### Вариант 1: Вертикальная схема (сверху вниз)

```
┌─────────────────────────────────┐
│   Developer Code                │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│   GroupManager (High-Level API) │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│   Safe Call Wrapper             │
└──────────────┬──────────────────┘
               │
       ┌───────┴───────┐
       │               │
       ▼               ▼
┌──────────┐   ┌──────────────┐
│  Quotas  │   │ Token Bucket │
└──────────┘   └──────┬───────┘
                     │
                     ▼
┌─────────────────────────────────┐
│   Telegram Client + Session     │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│   Telegram API (Servers)        │
└─────────────────────────────────┘
```

### Вариант 2: Горизонтальная схема (слева направо)

```
Developer → GroupManager → Safe Call → [Quotas + Token Bucket] → Client + Session → Telegram API
```

### Вариант 3: Центрированная схема (Safe Call в центре)

```
        Developer
            │
            ▼
      GroupManager
            │
            ▼
    ┌───────────────┐
    │  Safe Call    │◄─── Token Bucket
    │   Wrapper     │◄─── Quotas
    └───────┬───────┘
            │
            ▼
    Client + Session
            │
            ▼
      Telegram API
```

---

## 🔍 Детали для прорисовки

### Session файл:
- Покажи как файл с расширением `.session`
- Права доступа: `600` (rw-------)
- Путь: `data/sessions/s16_session.session`
- Внутри: токены авторизации (можно показать как зашифрованные данные)

### Token Bucket:
- Ведро с токенами (можно как шарики или блоки)
- Покажи capacity (10) и текущее количество (например, 8)
- Стрелка пополнения сверху (4 токена/сек)
- Стрелка расхода снизу (1 токен на запрос)

### Safe Call Wrapper:
- Покажи как обертка/контейнер вокруг функции
- Внутри: этапы (проверка квот → токен → выполнение → retry)
- Стрелки показывают последовательность

### Quotas:
- Прогресс-бары для DM и Join
- Файл счетчиков с данными
- Часы/таймер для сброса в 00:00 UTC

### Metrics:
- Графики/диаграммы метрик
- Счетчики с числами
- Гистограмма задержек

---

## 💡 Идеи для визуализации

1. **Анимация потока**: Покажи как запрос "течет" через систему
2. **Цветовое кодирование**: Разные цвета для разных типов операций
3. **Размеры**: Больше = важнее компонент
4. **Группировка**: Сгруппируй связанные компоненты
5. **Легенда**: Объясни что означают цвета/стрелки/иконки

---

## 📝 Текст для схемы

### Заголовок:
"Архитектура системы доступа к Telegram: Session Management + Anti-Spam защита"

### Подзаголовки:
- "Компоненты системы"
- "Поток данных: от запроса до ответа"
- "Детали компонентов"

### Легенда:
- 🔵 Session Management
- 🟢 Rate Limiting
- 🟡 Safe Call Wrapper
- 🟣 High-Level API
- 🔴 Telegram API
- ⚪ Metrics

---

## ✅ Чек-лист для дизайнера

- [ ] Показаны все 5 основных компонентов
- [ ] Показан поток данных от разработчика до Telegram API
- [ ] Визуализирован Token Bucket (ведро с токенами)
- [ ] Показан Session файл с правами доступа
- [ ] Показаны квоты (DM и Join) как прогресс-бары
- [ ] Показан Safe Call как обертка вокруг API вызовов
- [ ] Использованы разные цвета для разных компонентов
- [ ] Стрелки показывают направление потока данных
- [ ] Добавлена легенда с объяснением элементов
- [ ] Схема понятна без чтения документации

