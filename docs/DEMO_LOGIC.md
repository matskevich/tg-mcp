# üé¨ –õ–æ–≥–∏–∫–∞ –¥–µ–º–æ: Session + Anti-Spam —Å–∏—Å—Ç–µ–º–∞

## üéØ –¶–µ–ª—å –¥–µ–º–æ

–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Telegram —á–µ—Ä–µ–∑ session-—Ñ–∞–π–ª—ã –∏ –∞–Ω—Ç–∏—Å–ø–∞–º –∑–∞—â–∏—Ç—É. –î–µ–º–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –ø–æ—à–∞–≥–æ–≤–æ.

---

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ–º–æ (5 —ç—Ç–∞–ø–æ–≤)

### –≠–¢–ê–ü 1: Session Management (—Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º:**
- –ö–∞–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è session-—Ñ–∞–π–ª –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
- –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π session –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è (–ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ 600)

**–ó–∞—á–µ–º:**
- –ü–æ–Ω—è—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±–µ–∑ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –∫–æ–¥–∞
- –ü–æ–∫–∞–∑–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

**–ö–∞–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è:**
```python
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è session
session_path = "data/sessions/demo_session.session"
session_exists = Path(session_path).exists()

# 2. –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç session –µ—Å–ª–∏ –µ—Å—Ç—å)
client = get_client_for_session(session_path)

# 3. –ó–∞–ø—É—Å–∫ (–µ—Å–ª–∏ session –µ—Å—Ç—å - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è)
await client.start()  # –ï—Å–ª–∏ session –Ω–µ—Ç - –∑–∞–ø—Ä–æ—Å–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω + –∫–æ–¥

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
file_mode = Path(session_path).stat().st_mode & 0o777
assert file_mode == 0o600, "Session file must have 600 permissions"
```

**–ó–∞–¥–∞—á–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ `tele_client.py`:**
- `get_client()` / `get_client_for_session()` - —Å–æ–∑–¥–∞—é—Ç `TelegramClient` —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º session-—Ñ–∞–π–ª–æ–º
- `_harden_session_storage()` - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∞ 600 –Ω–∞ session-—Ñ–∞–π–ª –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º `client.start()` - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω + –∫–æ–¥, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `.session`
- –ü—Ä–∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—É—Å–∫–∞—Ö - —á–∏—Ç–∞–µ—Ç `.session`, –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–ü–æ—á–µ–º—É —Ç–∞–∫:**
- Telethon —Ö—Ä–∞–Ω–∏—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –≤ `.session` —Ñ–∞–π–ª–µ
- –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞ —Ç–æ–∫–µ–Ω—ã –≤–∞–ª–∏–¥–Ω—ã –¥–æ –æ—Ç–∑—ã–≤–∞ –∏–ª–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- –ü—Ä–∞–≤–∞ 600 (rw-------) –∑–∞—â–∏—â–∞—é—Ç –æ—Ç —á—Ç–µ–Ω–∏—è –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

---

### –≠–¢–ê–ü 2: Rate Limiter (Token Bucket)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º:**
- –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç token bucket –∞–ª–≥–æ—Ä–∏—Ç–º
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (4 RPS)
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –≤ "–≤–µ–¥—Ä–µ"

**–ó–∞—á–µ–º:**
- –ü–æ–Ω—è—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏
- –£–≤–∏–¥–µ—Ç—å –∫–∞–∫ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤

**–ö–∞–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è:**
```python
# 1. –ü–æ–ª—É—á–∞–µ–º rate limiter
limiter = get_rate_limiter()

# 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ bucket
print(f"Tokens in bucket: {limiter.bucket.tokens:.2f}/{limiter.bucket.capacity}")
print(f"Refill rate: {limiter.bucket.refill_rate} tokens/sec")

# 3. –î–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
for i in range(10):
    start = time.time()
    await limiter.bucket.acquire(1)
    elapsed = time.time() - start
    print(f"Request {i+1}: waited {elapsed:.2f}s, tokens left: {limiter.bucket.tokens:.2f}")
```

**–ó–∞–¥–∞—á–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ `TokenBucket`:**
- –•—Ä–∞–Ω–∏—Ç "—Ç–æ–∫–µ–Ω—ã" –≤ "–≤–µ–¥—Ä–µ" (capacity = 10, refill_rate = 4/sec)
- –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ç—Ä–∞—Ç–∏—Ç —Ç–æ–∫–µ–Ω, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ—Ç - –∂–¥–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω—ã —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é refill_rate

**–ü–æ—á–µ–º—É —Ç–∞–∫:**
- Telegram –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
- Token bucket –ø–æ–∑–≤–æ–ª—è–µ—Ç "–Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å" —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ –ø—Ä–æ—Å—Ç–æ–µ
- –ü–ª–∞–≤–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –±–µ–∑ —Ä–µ–∑–∫–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

---

### –≠–¢–ê–ü 3: Safe Call Wrapper (–∑–∞—â–∏—Ç–∞ API –≤—ã–∑–æ–≤–æ–≤)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º:**
- –ö–∞–∫ `safe_call` –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –∫–∞–∂–¥—ã–π API –≤—ã–∑–æ–≤
- Rate limiting –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –≤—ã–∑–æ–≤–æ–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ FLOOD_WAIT

**–ó–∞—á–µ–º:**
- –ü–æ–∫–∞–∑–∞—Ç—å –µ–¥–∏–Ω—É—é —Ç–æ—á–∫—É –∑–∞—â–∏—Ç—ã –≤—Å–µ—Ö API –≤—ã–∑–æ–≤–æ–≤
- –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ Telegram

**–ö–∞–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è:**
```python
# 1. –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ (–ë–ï–ó –∑–∞—â–∏—Ç—ã) - –ù–ï –î–ï–õ–ê–ï–ú –¢–ê–ö
# me = await client.get_me()  # ‚ùå

# 2. –ó–∞—â–∏—â–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ safe_call
me = await safe_call(
    client.get_me,
    operation_type="api"
)

# 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤–Ω—É—Ç—Ä–∏:
# - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç (–µ—Å–ª–∏ operation_type="dm" –∏–ª–∏ "join")
# - –û–∂–∏–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ bucket
# - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
# - Retry –ø—Ä–∏ FLOOD_WAIT —Å exponential backoff
```

**–ó–∞–¥–∞—á–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ `safe_call()`:**
- –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –≤—Å–µ—Ö Telegram API –≤—ã–∑–æ–≤–æ–≤
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–≤–æ—Ç—ã –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º (–¥–ª—è DM/join –æ–ø–µ—Ä–∞—Ü–∏–π)
- –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ bucket –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `FloodWaitError` —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º retry
- –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —Å —Ç–µ–≥–æ–º `[SAFE]`

**–ü–æ—á–µ–º—É —Ç–∞–∫:**
- –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –≤—Å–µ—Ö API –≤—ã–∑–æ–≤–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Telegram
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–∞

---

### –≠–¢–ê–ü 4: –ö–≤–æ—Ç—ã (Daily Limits)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º:**
- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã (DM: 20/–¥–µ–Ω—å, Join: 20/–¥–µ–Ω—å)
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –≤ 00:00 UTC

**–ó–∞—á–µ–º:**
- –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ Telegram
- –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏

**–ö–∞–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è:**
```python
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤
limiter = get_rate_limiter()
stats = limiter.get_stats()
print(f"DM today: {stats['dm_usage']}")
print(f"Joins today: {stats['join_usage']}")

# 2. –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç
try:
    for i in range(25):  # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 25 DM –ø—Ä–∏ –ª–∏–º–∏—Ç–µ 20
        await safe_call(
            client.send_message,
            "some_user",
            f"Message {i+1}",
            operation_type="dm"
        )
except Exception as e:
    print(f"Quota exceeded: {e}")

# 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∞–π–ª —Å—á–µ—Ç—á–∏–∫–æ–≤
counter_file = Path("data/anti_spam/daily_counters.txt")
print(f"Counters file: {counter_file.read_text()}")
```

**–ó–∞–¥–∞—á–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ `RateLimiter` (–∫–≤–æ—Ç—ã):**
- –•—Ä–∞–Ω–∏—Ç —Å—á–µ—Ç—á–∏–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ `daily_counters.txt`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–≤–æ—Ç—ã –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ü–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–Ω—è
- –ú–µ—Ç–æ–¥—ã: `check_dm_quota()`, `increment_dm_counter()`, `check_join_quota()`

**–ü–æ—á–µ–º—É —Ç–∞–∫:**
- Telegram –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ DM –∏ join –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –¥–µ–Ω—å
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –≤–µ–¥–µ—Ç –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω—É–∂–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

### –≠–¢–ê–ü 5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (—Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º:**
- –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: session ‚Üí rate limiter ‚Üí safe_call ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
- –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ó–∞—á–µ–º:**
- –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ
- –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

**–ö–∞–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è:**
```python
# 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å session
client = get_client()
await client.start()

# 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ GroupManager (–∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç safe_call)
manager = GroupManager(client)

# 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥—Ä—É–ø–ø–µ (–∑–∞—â–∏—â–µ–Ω–æ –∞–Ω—Ç–∏—Å–ø–∞–º)
group_info = await manager.get_group_info("s16_space")

# 4. –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Å smart_pause –∫–∞–∂–¥—ã–µ 1000)
participants = await manager.get_participants("s16_space", limit=100)

# 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
limiter = get_rate_limiter()
stats = limiter.get_stats()
metrics = snapshot()  # –ò–∑ metrics.py

print(f"""
üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–ê–ë–û–¢–´:
- API –≤—ã–∑–æ–≤–æ–≤: {stats['api_calls']}
- FLOOD_WAIT —Å–æ–±—ã—Ç–∏–π: {stats['flood_waits']}
- Rate limit throttles: {metrics['rate_limit_throttled_total']}
- –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞: {calculate_avg_latency(metrics)}
""")
```

**–ó–∞–¥–∞—á–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ `GroupManager`:**
- –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥—Ä—É–ø–ø–∞–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `_safe_api_call()` –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç `smart_pause()` –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –°–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –∞–Ω—Ç–∏—Å–ø–∞–º —Å–∏—Å—Ç–µ–º—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü–æ—á–µ–º—É —Ç–∞–∫:**
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏: –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –¥–µ—Ç–∞–ª–∏ –≤ `limiter.py`
- –£–¥–æ–±–Ω—ã–π API –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã (–¥–µ—Ç–∞–ª—å–Ω–æ)

### 1. `tele_client.py` - Session Management

**–ó–∞–¥–∞—á–∞:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ session-—Ñ–∞–π–ª–∞–º–∏

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç `TelegramClient` —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º session-—Ñ–∞–π–ª–æ–º
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (600) –Ω–∞ session-—Ñ–∞–π–ª—ã
- –ö–µ—à–∏—Ä—É–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–π –≤—Ö–æ–¥ (–∑–∞–ø—Ä–æ—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ + –∫–æ–¥–∞)

**–ü–æ—á–µ–º—É –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:**
- –ò–∑–æ–ª—è—Ü–∏—è –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å session
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö session –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

---

### 2. `limiter.py` - Rate Limiting & Quotas

**–ó–∞–¥–∞—á–∞:** –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–≤–æ—Ç

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

#### TokenBucket:
- –•—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω—ã –≤ "–≤–µ–¥—Ä–µ"
- –ü–æ–ø–æ–ª–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω—ã —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é refill_rate
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ—Ç

#### RateLimiter:
- –£–ø—Ä–∞–≤–ª—è–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–º rate limiter (singleton)
- –•—Ä–∞–Ω–∏—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–≤–æ—Ç—ã –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ü–∏–π
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—á–µ—Ç—á–∏–∫–∏ –≤ —Ñ–∞–π–ª –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

#### safe_call():
- –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –≤—Å–µ—Ö Telegram API –≤—ã–∑–æ–≤–æ–≤
- –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ bucket –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç FloodWaitError —Å retry
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ

#### smart_pause():
- –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–∞—É–∑—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –†–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π

**–ü–æ—á–µ–º—É –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:**
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞–º–∏
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏
- –õ–µ–≥–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

---

### 3. `groups.py` - High-level API

**–ó–∞–¥–∞—á–∞:** –£–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥—Ä—É–ø–ø–∞–º–∏

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- `GroupManager` - –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥—Ä—É–ø–ø–∞–º–∏
- `_safe_api_call()` - helper –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è safe_call
- –ú–µ—Ç–æ–¥—ã: `get_group_info()`, `get_participants()`, `search_participants()`

**–ü–æ—á–µ–º—É –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:**
- –°–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –∞–Ω—Ç–∏—Å–ø–∞–º —Å–∏—Å—Ç–µ–º—ã
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–¥–æ–±–Ω—ã–π API
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∑–∞—â–∏—Ç—É

---

### 4. `metrics.py` - Observability

**–ó–∞–¥–∞—á–∞:** –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°—á–µ—Ç—á–∏–∫–∏: requests_total, throttled_total, flood_wait_events
- –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –∑–∞–¥–µ—Ä–∂–µ–∫ API –≤—ã–∑–æ–≤–æ–≤
- Thread-safe –æ–ø–µ—Ä–∞—Ü–∏–∏

**–ü–æ—á–µ–º—É –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:**
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –õ–µ–≥–∫–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Prometheus/Grafana

---

## üé¨ –°—Ü–µ–Ω–∞—Ä–∏–π –¥–µ–º–æ (–ø–æ—à–∞–≥–æ–≤–æ)

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ session
```
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ session-—Ñ–∞–π–ª–∞
2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 600)
3. –ï—Å–ª–∏ session –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π (–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω + –∫–æ–¥)
4. –ï—Å–ª–∏ session –µ—Å—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
```

### –®–∞–≥ 2: –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è Rate Limiter
```
1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ bucket (—Ç–æ–∫–µ–Ω—ã, capacity, refill_rate)
2. –î–µ–ª–∞–µ–º 10 –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —Ç–æ–∫–µ–Ω—ã —Ç—Ä–∞—Ç—è—Ç—Å—è –∏ –ø–æ–ø–æ–ª–Ω—è—é—Ç—Å—è
4. –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ–º throttling (–∫–æ–≥–¥–∞ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ—Ç)
```

### –®–∞–≥ 3: –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è Safe Call
```
1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –ø—Ä—è–º—ã–º –≤—ã–∑–æ–≤–æ–º –∏ safe_call
2. –î–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ API –≤—ã–∑–æ–≤–æ–≤ —á–µ—Ä–µ–∑ safe_call
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏ —Å —Ç–µ–≥–æ–º [SAFE]
4. –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É FLOOD_WAIT (–µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç)
```

### –®–∞–≥ 4: –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ö–≤–æ—Ç
```
1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å—á–µ—Ç—á–∏–∫–∏ (DM, Join)
2. –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —Å–∏—Å—Ç–µ–º–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∞–π–ª —Å—á–µ—Ç—á–∏–∫–æ–≤ (data/anti_spam/daily_counters.txt)
```

### –®–∞–≥ 5: –†–µ–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä
```
1. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–µ —á–µ—Ä–µ–∑ GroupManager
2. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Å smart_pause)
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ API –≤—ã–∑–æ–≤–æ–≤
   - FLOOD_WAIT —Å–æ–±—ã—Ç–∏—è
   - Rate limit throttles
   - –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞
```

---

## üîç –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è –¥–µ–º–æ

1. **Session = –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –±–µ–∑ –∫–æ–¥–∞** - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞ –∫–æ–¥ –Ω–µ –Ω—É–∂–µ–Ω
2. **Token Bucket = –ø–ª–∞–≤–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ** - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–µ–∑–∫–æ, –∞ –ø–ª–∞–≤–Ω–æ –∑–∞–º–µ–¥–ª—è–µ—Ç
3. **Safe Call = –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞** - –≤—Å–µ API –≤—ã–∑–æ–≤—ã –∑–∞—â–∏—â–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. **–ö–≤–æ—Ç—ã = –∑–∞—â–∏—Ç–∞ –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** - —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –¥–∞—Å—Ç –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã Telegram
5. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è = –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –¥—É–º–∞–µ—Ç –æ –∑–∞—â–∏—Ç–µ, –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## ‚ö†Ô∏è –ß—Ç–æ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –¥–µ–º–æ

- –†–µ–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –∏–ª–∏ –∫–æ–¥—ã
- –†–µ–∞–ª—å–Ω—ã–µ session-—Ñ–∞–π–ª—ã (—Ç–æ–ª—å–∫–æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏)
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞—Ö
- –°–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

---

## üìù –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥

–ï—Å–ª–∏ –¥–µ–º–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª–µ–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é token bucket –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ì—Ä–∞—Ñ–∏–∫–∏ –º–µ—Ç—Ä–∏–∫ (requests/sec, latency)
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –°–∏–º—É–ª—è—Ü–∏—é FLOOD_WAIT –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ retry –ª–æ–≥–∏–∫–∏

